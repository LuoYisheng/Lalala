    'ActiveSheet.PivotTables("PivotTable1").ChangePivotCache ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:= _
    '"Data!R1C1:R63C15", Version:=xlPivotTableVersion14)
        'ActiveSheet.PivotTables("PivotTable2").ChangePivotCache ("PivotTable1")
     ''ActiveSheet.PivotTables("PivotTable6").ChangePivotCache ActiveWorkbook. _
        'PivotCaches.Create(SourceType:=xlDatabase, SourceData:="Data!R1C1:R65C15", Version:=xlPivotTableVersion14)

Sub main()
    'WE define
    Dim WD, WE As Integer
    WD = WorksheetFunction.Weekday(Date)
    
    If WD = 2 Then
    WE = 3
    Else
    WE = 1
    End If

    'Age report filename
    Dim CasePC As String
    CasePC = Dir(ActiveWorkbook.Path & "\Case pending check image" & Format(Date, "yyyy-mm-dd") & "*.xls")
    Dim AgeRp As String
    AgeRp = Dir(ActiveWorkbook.Path & "\AIR Report" & Format(Date, "yyyy-mm-dd") & "*.xls")

    'Open Workbooks
    Workbooks.Open (ActiveWorkbook.Path & "\RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx")
    On Error Resume Next
    Workbooks.Open (ActiveWorkbook.Path & "\Daily MIS on WIP.xls")
    On Error Resume Next
    Workbooks.Open (ActiveWorkbook.Path & "\" & CasePC)
    On Error Resume Next
    Workbooks.Open (ActiveWorkbook.Path & "\" & AgeRp)
    On Error Resume Next
    
    'Update Banker Database
    Workbooks("RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx").Activate
    Worksheets("Above 30 Days").Activate
    Cells.Copy
    Workbooks("TEST.xlsm").Activate
    Worksheets("Above 30 Days").Activate
    Range("A1").Select
    ActiveSheet.Paste
    
    'Update Above 30 Days
    Workbooks("RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx").Activate
    Worksheets("Banker Database").Activate
    Cells.Copy
    Workbooks("TEST.xlsm").Activate
    Worksheets("Banker Database").Activate
    Range("A1").Select
    ActiveSheet.Paste
    
    'Get Case ID
    Worksheets("Data").Activate
    Columns("A:O").AutoFit
    Workbooks("Daily MIS on WIP.xls").Activate
    Worksheets("Detailed Report").Activate
    ActiveSheet.Range("B4:O2000").AutoFilter Field:=6, Criteria1:="=RMINQ"
    Range("B4").Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Copy
    Workbooks("TEST.xlsm").Activate
    Worksheets("Data").Activate
    Range("A1").PasteSpecial (xlPasteValuesAndNumberFormats)
    
    'Pre-Manual Filter Step
    Dim Row1
    Row1 = Range("A1", Range("A2").End(xlDown)).Rows.Count
    
    Range("B2:B" & Row1).Select
    Selection.Value = "MIS"
    
    Workbooks("RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx").Activate
    Worksheets("Data").Activate
    Range("A2").Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Copy
    Workbooks("TEST.xlsm").Activate
    Worksheets("Data").Activate
    Range("A" & (Row1 + 1)).PasteSpecial (xlPasteValuesAndNumberFormats)
    Dim Row2
    Row2 = Range("A1", Range("A2").End(xlDown)).Rows.Count
    Range("B" & (Row1 + 1) & ":B" & Row2).Value = "Pre"
    
    Range("c2:c" & Row2).Select
    Selection.Formula = "=countif(C1:C1,RC[-2])"
    Range("d2:d" & Row2).Select
    Selection.Formula = "=if(RC[-1]=2,0,if(RC[-2]=""MIS"",1,-1))"
    
    Range("C2:D" & Row2).Select
    Selection.Copy
    Range("C2").PasteSpecial (xlPasteValues)
    

    'Conditional Formatting
    'Range("A2:R" & Row2).Select
    'Selection.FormatConditions.Add Type:=xlExpression, Formula1:="=$D2=1"
    'Selection.FormatConditions(Selection.FormatConditions.Count).SetFirstPriority
    'With Selection.FormatConditions(1).Interior
    '    .PatternColorIndex = xlAutomatic
    '    .Color = 5296274
    '    .TintAndShade = 0
    'End With

    'Range("A2:R" & Row2).Select
    'Selection.FormatConditions.Add Type:=xlExpression, Formula1:="=$D2=-1"
    'Selection.FormatConditions(Selection.FormatConditions.Count).SetFirstPriority
    'With Selection.FormatConditions(1).Interior
    '    .PatternColorIndex = xlAutomatic
    '    .Color = vbRed
    '    .TintAndShade = 0
    'End With
    
    
    
    'Circuit
    Dim Firstrow As Long
    Dim Lastrow As Long
    Dim Lrow As Long
    
    'Color
    With ActiveSheet.Select
    Firstrow = 2
    Lastrow = Row2
    For Lrow = Lastrow To Firstrow Step -1
        If Cells(Lrow, "D") = 1 Then
        Range("A" & Lrow & ":T" & Lrow).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorAccent3
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
        End If
        If Cells(Lrow, "D") = -1 Then
            Range("A" & Lrow & ":T" & Lrow).Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorAccent2
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
        End If
    Next Lrow
    End With
        
    
    'Delete Extra Rows and Columns
    With ActiveSheet.Select
    Firstrow = 2
    Lastrow = Row2
    For Lrow = Lastrow To Firstrow Step -1
        If Cells(Lrow, "B") = "Pre" Then
            If Cells(Lrow, "C") = 2 Then Cells(Lrow, "C").EntireRow.Delete
        End If

    Next Lrow
    End With
    
    Range("B:D").Delete
    
    
    
    'Info update
    Dim RowNum
    RowNum = Range("A1", Range("A2").End(xlDown)).Rows.Count
    Range("B2:B" & RowNum).Select
    Selection.Formula = "=IFerror(vlookup(RC[-1],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,2,false),vlookup(RC[-1],'[Daily MIS on WIP.xls]Detailed Report'!R4C2:R1500C15,10,false))"
    Range("C2:C" & RowNum).Select
    Selection.Formula = "=IFerror(vlookup(RC[-2],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,3,false),vlookup(RC[-2],'[Daily MIS on WIP.xls]Detailed Report'!R4C2:R1500C15,11,false))"
    Range("D2:D" & RowNum).Select
    Selection.Formula = "=IFerror(vlookup(RC[-3],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,4,false),vlookup(RC[-3],'[Daily MIS on WIP.xls]Detailed Report'!R4C2:R1500C15,3,false))"
    Selection.NumberFormat = "dd-mmm"
    Range("E2:E" & RowNum).Select
    'Selection.Formula = "=roundup(Today()-RC[-1],0)"
    Selection.Formula = "=IFerror(vlookup(RC[-4],'[Daily MIS on WIP.xls]Detailed Report'!R4C2:R1500C15,5,false),""Deleted"")"
    Range("F2:F" & RowNum).Select
    Selection.Formula = "=IFerror(vlookup(RC[-5],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,6,false),vlookup(RC[-5],'[Daily MIS on WIP.xls]Detailed Report'!R4C2:R1500C15,12,false))"
    
    'Aging-banker email change
    Workbooks(AgeRp).Activate
    Columns("D:D").Select
    Selection.Replace What:=",*", Replacement:="", LookAt:=xlPart, _
    SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
    ReplaceFormat:=False

    'back
    Workbooks("test.xlsm").Activate
    Range("G2:G" & RowNum).Select
    Selection.Formula = "=iferror(IFerror(vlookup(RC[-6],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,7,false),VLOOKUP(RC[-6],'[" & AgeRp & "]Report 1'!C3:C4,2,FALSE)),""Not Found"")"
    Range("H2:H" & RowNum).Select
    Selection.Formula = "=IFERROR(VLOOKUP(RC[-1],'Banker Database'!C1:C2,2,FALSE),""Add to Database"")"
    Range("I2:I" & RowNum).Select
    Selection.Formula = "=IFERROR(VLOOKUP(RC[-1],'Banker Database'!C2:C3,2,FALSE),""Add to Database"")"
    Range("J2:J" & RowNum).Select
    Selection.Formula = "=if(IFerror(vlookup(RC[-9],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,10,false),""NEW"")="""","""",IFerror(vlookup(RC[-9],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,10,false),""NEW""))"
    
    'Aging rearrange
    Workbooks(AgeRp).Activate
    Range("A5").Select
    ActiveCell.FormulaR1C1 = "1"
    Range("A6").Select
    ActiveCell.FormulaR1C1 = "2"
    
    Dim RowNum3
    RowNum3 = Range("B4", Range("b5").End(xlDown)).Rows.Count + 3

    Range("A5:A6").Select
    Selection.AutoFill Destination:=Range("A5:A" & RowNum3)
    
    ActiveWorkbook.Worksheets("Report 1").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Report 1").Sort.SortFields.Add Key:=Range("A4"), _
        SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Report 1").Sort
        .SetRange Range("A:M")
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
    'Aging
    Workbooks("test.xlsm").Activate
    Range("k2:k" & RowNum).Select
    'Selection.Formula = "=if(IFERROR(VLOOKUP(RC[-10],'[" & AgeRp & "]Report 1'!C3:C6,4,FALSE),""Not Found"")="""","""",IFERROR(VLOOKUP(RC[-10],'[" & AgeRp & "]Report 1'!C3:C6,4,FALSE),""Not Found""))"
    Selection.Formula = "=if(IFERROR(VLOOKUP(RC[-10],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,11,false)," & CDbl(Date - WE) & ")="""","""",iferror(VLOOKUP(RC[-10],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,11,false)," & CDbl(Date - WE) & "))"
    Selection.NumberFormat = "dd-mmm"
    
    '=IF(M2="",TODAY()-K2,M2-TODAY())
    Range("l2:l" & RowNum).Select
    Selection.Formula = "=roundup(IF(M2="""",TODAY()-K2,M2-TODAY()),0)"
    
    Range("m2:m" & RowNum).Select
    'Selection.Formula = "=if(IFERROR(VLOOKUP(RC[-12],'[" & AgeRp & "]Report 1'!C3:C5,3,FALSE),""Not Found"")="""","""",IFERROR(VLOOKUP(RC[-12],'[" & AgeRp & "]Report 1'!C3:C5,3,FALSE),""Not Found""))"
    'Selection.Formula = "=if(IFERROR(VLOOKUP(RC[-12],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,13,false),""NEW"")="""","""",IFERROR(VLOOKUP(RC[-12],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,13,false),""NEW""))"
    'Selection.Formula = "=if(RC[+1]=""Open Hub"",if(IFERROR(VLOOKUP(RC[-12],'[" & AgeRp & "]Report 1'!C3:C5,3,FALSE),""Not Found"")="""",today()-1,IFERROR(VLOOKUP(RC[-12],'[" & AgeRp & "]Report 1'!C3:C5,3,FALSE),""Not Found"")),"""")"
    Selection.Formula = "=if(RC[+1]=RC[+2],if(VLOOKUP(RC[-12],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,13,false)=0,"""",VLOOKUP(RC[-12],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,13,false)),if(RC[+1]=""Open Hub"",today() - " & WE & ",""""))"
    Selection.NumberFormat = "dd-mmm"
    
    Range("n2:n" & RowNum).Select
    Selection.Formula = "=IFERROR(VLOOKUP(RC[-13],'[" & AgeRp & "]Report 1'!C3:C13,11,FALSE),""Not Found"")"
    Range("o2:o" & RowNum).Select
    Selection.Formula = "=IFERROR(VLOOKUP(RC[-14],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,14,false),""Not Found"")"
    
    With ActiveSheet.Select
    Firstrow = 2
    Lastrow = Row2
    For Lrow = Lastrow To Firstrow Step -1
        If Cells(Lrow, "O") <> Cells(Lrow, "n") Then
            Cells(Lrow, "O").Select
            With Selection.Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorAccent6
            .TintAndShade = 0
            .PatternTintAndShade = 0
            End With
        End If
    Next Lrow
    End With

    Range("p2:p" & RowNum).Select
    Selection.Formula = "=if(IFerror(vlookup(RC[-15],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,15,false),"" "")="""","""",IFerror(vlookup(RC[-15],'[RMINQ_CPB TTM_" & Format(Date - WE, "mmddyyyy") & ".xlsx]Data'!R2C1:R300C15,15,false),""""))"
        
    Range("Q2:Q" & RowNum).Select
    Selection.Formula = "=if(RC[-3]=""Not Found"",iferror(vlookup(RC[-16],'[" & CasePC & "]Report 1'!C2:C14,13,FALSE),""Not Found in Check Image""),"""")"
    
    Range("A1").Select
    Selection.AutoFilter
    ActiveWorkbook.Worksheets("Data").AutoFilter.Sort.SortFields.Add Key:=Range( _
        "A1:A" & RowNum), SortOn:=xlSortOnCellColor, Order:=xlDescending, DataOption:= _
        xlSortNormal
    With ActiveWorkbook.Worksheets("Data").AutoFilter.Sort
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
    Range("o1").Select
    Selection.AutoFilter
    Selection.AutoFilter
    ActiveWorkbook.Worksheets("Data").AutoFilter.Sort.SortFields.Add Key:=Range( _
        "o1:o" & RowNum), SortOn:=xlSortOnCellColor, Order:=xlDescending, DataOption:= _
        xlSortNormal
    With ActiveWorkbook.Worksheets("Data").AutoFilter.Sort
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
    Columns("A:Q").AutoFit

    'Autofit and borders
    Range("A1").Select
End Sub

Sub UpdatePivot()
    Dim RowNum2
    Worksheets("Data").Activate
    RowNum2 = Range("A1", Range("A2").End(xlDown)).Rows.Count
    
    Worksheets("Report").Activate
    ActiveSheet.PivotTables("PivotTable2").ChangePivotCache ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:="Data!R1C1:R" & RowNum2 & "C15", Version:=xlPivotTableVersion14)
    With ActiveSheet.PivotTables("pivottable2")
    .PivotFields("Aging with banker").DataRange.Cells(1, 1).Group Start:=1, End:=60, By:=5
    End With
    ActiveSheet.PivotTables("PivotTable4").ChangePivotCache ("PivotTable2")
    With ActiveSheet.PivotTables("pivottable4")
    .PivotFields("DATE REPLY RECEIVED").PivotItems("").Visible = False
    End With
    ActiveSheet.PivotTables("PivotTable1").ChangePivotCache ("PivotTable2")
    ActiveSheet.PivotTables("PivotTable5").ChangePivotCache ("PivotTable2")
    ActiveSheet.PivotTables("PivotTable3").ChangePivotCache ("PivotTable2")
    Range("A1").Select
End Sub
